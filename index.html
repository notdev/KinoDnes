<!DOCTYPE html>
<html>

<head>
    <title>Kino Dnes</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.10/angular.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="style.min.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>

<body>
    <div ng-app="kino" ng-controller="kinoCtrl" class="container">
        <div class="loadersmall" ng-show="loading"></div>
        <div id="listings" style="display: none">
            <div ng-repeat="listing in cinemaListings" class="row">
                <div class="column" style="margin: 3% 0">
                    <h5>
                        <a href="http://www.google.com/search?q={{listing.CinemaName}}&btnI">{{hideCityName(listing.CinemaName);}}</a>
                    </h5>
                    <hr class="nadpis">
                    <div class="movie" ng-repeat="movie in listing.Movies">
                        <a href="{{movie.Url}}">{{movie.MovieName}}</a>
                        <span ng-if="0 < movie.Rating && movie.Rating < 30" class="shit"> {{movie.Rating}} %</span>
                        <span ng-if="30 <= movie.Rating && movie.Rating < 70" class="prumer"> {{movie.Rating}} %</span>
                        <span ng-if="70 <= movie.Rating" class="dobre"> {{movie.Rating}} %</span><br>
                        <code ng-repeat="time in movie.Times">{{time.Time | date : 'HH:mm'}} <span>{{time.Flags.join(',')}}</span></code>
                    </div>
                </div>
            </div>
        </div>
        <div id="districtButtons" style="display: none;">
            <div ng-repeat="city in cityList">
                <button ng-click="selectCity(city)">{{city}}</button>
            </div>
        </div>
        <div id="noMoviesMessage" style="display: none;">
            <div class="container" style="margin: 0 auto;">
                <h5>Dnes jiz v kině nic nedávají, zkuste to znovu zítra.</h5>
            </div>
        </div>
        <script>
            var app = angular.module('kino', []);
            app.controller('kinoCtrl',
                function ($scope, $http) {
                    $scope.loading = true;

                    $scope.displayCinemas = function (cityName) {
                        $http.get("https://kinodnesapi.azurewebsites.net/api/kino/" + cityName)
                            .then(function (response) {
                                if (response.data.length === 0) {
                                    document.getElementById("noMoviesMessage").style.display = "";
                                }
                                $scope.cinemaListings = response.data;
                                $scope.loading = false;
                                document.getElementById("listings").style.display = "";
                            });
                    };

                    $scope.selectCity = function (cityName) {
                        $scope.loading = true;
                        document.getElementById("districtButtons").style.display = "none";
                        var newLocation = location.href + cityName;
                        history.pushState(newLocation, "", newLocation);
                        $scope.displayCinemas(cityName);
                    };

                    $scope.hideCityName = function (cityAndCinema) {
                        return cityAndCinema.replace(/.*?- /, "");
                    };

                    $scope.displayCityList = function() {
                        history.pushState(location.href, "", location.href);
                        $http.get("https://kinodnesapi.azurewebsites.net/api/kino/Cities")
                            .then(function (response) {
                                $scope.cityList = response.data;
                                document.getElementById("districtButtons").style.display = "";
                                $scope.loading = false;
                            });
                    }

                    var district = location.href.substr(location.href.lastIndexOf('/') + 1);
                    if (district.length == 0) {
                        $scope.displayCityList();
                    } else {
                        $scope.displayCinemas(district);
                    }
                });

            window.onpopstate = function (e) {
                if (e.state) {
                    location.href = e.state;                    
                }
            };
        </script>
    </div>
    <script>
                (function (i, s, o, g, r, a, m) {
                    i['GoogleAnalyticsObject'] = r;
                    i[r] = i[r] ||
                        function () {
                            (i[r].q = i[r].q || []).push(arguments);
                        }, i[r].l = 1 * new Date();
                    a = s.createElement(o),
                        m = s.getElementsByTagName(o)[0];
                    a.async = 1;
                    a.src = g;
                    m.parentNode.insertBefore(a, m);
                })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

                ga('create', 'UA-82408384-1', 'auto');
                ga('send',
                    {
                        hitType: 'pageview',
                        page: location.pathname
                    });
    </script>
</body>
</html>